// const express = require("express"); 
// const cors = require("cors"); 
// const bodyParser = require("body-parser"); 
// const mysql = require("mysql2"); 
// const app = express();
//  const PORT = 3000;
//   app.use(cors()); app.use(bodyParser.json()); 
//   const db = mysql.createPool({ host: "localhost", 
//     user: "root", 
//     password: "manager", 
//     database: "attendance_system" }); 
//     /* ================= BASIC BLOCK CRUD ================= */ 
//     app.get("/blocks", (req, res) => { db.query("SELECT * FROM blocks1 ORDER BY id DESC", (err, rows) => { if (err) return res.status(500).json(err); res.json(rows); }); });
//      app.post("/blocks", (req, res) => { const { name, location, column_breaks } = req.body; if (!name || !location) return res.status(400).json({ error: "Name and location required" });
//       const cols = Array.isArray(column_breaks) ? [...column_breaks] : []; while (cols.length < 10) cols.push(0); 
//       const sql = INSERT INTO blocks1 (name, location, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ; db.query(sql, [name, location, ...cols], (err, result) => { if (err) return res.status(500).json(err); res.json({ success: true, block_id: result.insertId }); }); }); app.put("/blocks/:id", (req, res) => { const { name, location, column_breaks } = req.body; const cols = Array.isArray(column_breaks) ? [...column_breaks] : []; while (cols.length < 10) cols.push(0); const sql = UPDATE blocks1 SET name = ?, location = ?, col1=?, col2=?, col3=?, col4=?, col5=?, col6=?, col7=?, col8=?, col9=?, col10=? WHERE id = ? ; db.query(sql, [name, location, ...cols, req.params.id], err => { if (err) return res.status(500).json(err); res.json({ success: true }); }); }); app.delete("/blocks/:id", (req, res) => { db.query("DELETE FROM blocks1 WHERE id = ?", [req.params.id], err => { if (err) return res.status(500).json(err); res.json({ success: true }); }); }); /* ================= tablesssss ================= */ app.get("/api/blocks", (req, res) => { db.query("SELECT * FROM blocks1", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/marksheet", (req, res) => { db.query("SELECT * FROM marksheet", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/institutes", (req, res) => { db.query("SELECT * FROM institutes", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/supervisor", (req, res) => { db.query("SELECT * FROM staff_details", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/paper_inventory", (req, res) => { db.query("SELECT * FROM paper_inventory", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/exam_timetable", (req, res) => { db.query("SELECT * FROM exam_timetable", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/seating_chart", (req, res) => { db.query("SELECT * FROM seating_chart", (err, result) => { if (err) return res.status(500).json(err); res.json(result); }); }); app.get("/api/block/:id", (req, res) => { const id = req.params.id; db.query("SELECT location FROM blocks WHERE id = ?", [id], (err, result) => { if (err) return res.status(500).send(err); res.json(result[0]); }); }); // Fetch all unique schemes from exam_timetable app.get("/api/schemes", async (req, res) => { try { const [rows] = await db.promise().query( "SELECT DISTINCT scheme FROM exam_timetable ORDER BY scheme" ); res.json(rows); } catch (err) { console.error(err); res.status(500).json({ error: "Failed to load schemes" }); } }); // fetch(http://localhost:5000/api/block_allocation?date=${date}&session=${session}) // .then(res => res.json()) // .then(rows => { // const tableRows = document.querySelectorAll("#reportTableBody tr"); // rows.forEach((r, i) => { // if (!tableRows[i]) return; // tableRows[i].querySelector(".instCell").innerText = r.inst_code; // tableRows[i].querySelector(".courseCell").innerText = r.course; // }); // }); app.get("/api/block_allocation", (req, res) => { const { date, session } = req.query; const sql = SELECT institute_code, course FROM marksheet WHERE session = ? ORDER BY id ; db.query(sql, [ session], (err, rows) => { if (err) return res.status(500).send(err); res.json(rows); }); }); /* ================= START SERVER ================= */ app.listen(PORT, () => { console.log(Server running on http://localhost:${PORT}); });
const express = require("express");
const cors = require("cors");
const bodyParser = require("body-parser");
const mysql = require("mysql2");

const app = express();
const PORT = 3000;

app.use(cors());
app.use(bodyParser.json());

const db = mysql.createPool({
  host: "localhost",
  user: "root",
  password: "manager",
  database: "attendance_system"
});

/* ================= BASIC BLOCK CRUD ================= */
app.get("/blocks", (req, res) => {
  db.query("SELECT * FROM blocks1 ORDER BY id DESC", (err, rows) => {
    if (err) return res.status(500).json(err);
    res.json(rows);
  });
});

app.post("/blocks", (req, res) => {
  const { name, location, column_breaks } = req.body;
  if (!name || !location) return res.status(400).json({ error: "Name and location required" });

  const cols = Array.isArray(column_breaks) ? [...column_breaks] : [];
  while (cols.length < 10) cols.push(0);

  const sql = `
    INSERT INTO blocks1
    (name, location, col1, col2, col3, col4, col5, col6, col7, col8, col9, col10)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `;

  db.query(sql, [name, location, ...cols], (err, result) => {
    if (err) return res.status(500).json(err);
    res.json({ success: true, block_id: result.insertId });
  });
});

app.put("/blocks/:id", (req, res) => {
  const { name, location, column_breaks } = req.body;
  const cols = Array.isArray(column_breaks) ? [...column_breaks] : [];
  while (cols.length < 10) cols.push(0);

  const sql = `
    UPDATE blocks1 SET
      name = ?, location = ?,
      col1=?, col2=?, col3=?, col4=?, col5=?,
      col6=?, col7=?, col8=?, col9=?, col10=?
    WHERE id = ?
  `;

  db.query(sql, [name, location, ...cols, req.params.id], err => {
    if (err) return res.status(500).json(err);
    res.json({ success: true });
  });
});

app.delete("/blocks/:id", (req, res) => {
  db.query("DELETE FROM blocks1 WHERE id = ?", [req.params.id], err => {
    if (err) return res.status(500).json(err);
    res.json({ success: true });
  });
});

/* ================= API TABLES ================= */
app.get("/api/blocks", (req, res) => {
  db.query("SELECT * FROM blocks1", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/marksheet", (req, res) => {
  db.query("SELECT * FROM marksheet", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/institutes", (req, res) => {
  db.query("SELECT * FROM institutes", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/supervisor", (req, res) => {
  db.query("SELECT * FROM staff_details", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/paper_inventory", (req, res) => {
  db.query("SELECT * FROM paper_inventory", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/exam_timetable", (req, res) => {
  db.query("SELECT * FROM exam_timetable", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/seating_chart", (req, res) => {
  db.query("SELECT * FROM seating_chart", (err, result) => {
    if (err) return res.status(500).json(err);
    res.json(result);
  });
});

app.get("/api/block/:id", (req, res) => {
  const id = req.params.id;
  db.query("SELECT location FROM blocks WHERE id = ?", [id], (err, result) => {
    if (err) return res.status(500).send(err);
    res.json(result[0]);
  });
});

// Fetch unique schemes
app.get("/api/schemes", async (req, res) => {
  try {
    const [rows] = await db.promise().query(
      "SELECT DISTINCT scheme FROM exam_timetable ORDER BY scheme"
    );
    res.json(rows);
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Failed to load schemes" });
  }
});

// Block allocation
app.get("/api/block_allocation", (req, res) => {
  const { date, session } = req.query;
  const sql = `SELECT institute_code, course FROM marksheet WHERE session = ? ORDER BY id`;
  db.query(sql, [session], (err, rows) => {
    if (err) return res.status(500).send(err);
    res.json(rows);
  });
});

/* ================= START SERVER ================= */
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
